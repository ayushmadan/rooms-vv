name: Build and Release Windows Installer

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $version = "${{ github.event.inputs.version }}"
          } elseif ("${{ github.ref }}" -match "refs/tags/v(.+)") {
            $version = $matches[1]
          } else {
            $pkg = Get-Content package.json | ConvertFrom-Json
            $version = $pkg.version
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Building version: $version"

      - name: Update package.json version
        shell: pwsh
        run: |
          npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version --allow-same-version

      - name: Install dependencies
        run: npm ci

      - name: Verify setup
        shell: pwsh
        run: |
          echo "=== Verifying installation ==="
          echo "Checking node_modules/electron-builder:"
          if (Test-Path node_modules/electron-builder) {
            echo "✓ electron-builder directory exists"
          } else {
            echo "✗ ERROR: electron-builder NOT found!"
            exit 1
          }
          echo ""
          echo "Checking .bin/electron-builder:"
          if (Test-Path node_modules/.bin/electron-builder.cmd) {
            echo "✓ electron-builder.cmd exists"
          }
          echo ""
          echo "Running: node node_modules/electron-builder/out/cli/cli.js --version"
          node node_modules/electron-builder/out/cli/cli.js --version
          echo ""
          echo "electron version:"
          npx electron --version

      - name: Build NSIS Installer
        run: node node_modules/electron-builder/out/cli/cli.js --win nsis
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List output directory
        shell: pwsh
        run: |
          echo "Checking for dist directory..."
          if (Test-Path dist) {
            echo "dist directory exists!"
            echo "Contents:"
            Get-ChildItem dist -Recurse
          } else {
            echo "ERROR: dist directory does NOT exist!"
            echo "Current directory contents:"
            Get-ChildItem
          }

      - name: Get installer filename
        id: installer
        shell: pwsh
        run: |
          $installerFile = Get-ChildItem -Path dist\*.exe | Where-Object { $_.Name -notlike '*Web Setup*' } | Select-Object -First 1
          if ($installerFile) {
            echo "INSTALLER_PATH=$($installerFile.FullName)" >> $env:GITHUB_OUTPUT
            echo "INSTALLER_NAME=$($installerFile.Name)" >> $env:GITHUB_OUTPUT
            echo "Found installer: $($installerFile.Name)"
          } else {
            echo "Error: No installer file found in dist/"
            exit 1
          }

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          release_name: Vira Villas Rooms v${{ steps.version.outputs.VERSION }}
          body: |
            ## Vira Villas Rooms v${{ steps.version.outputs.VERSION }}

            ### Download and Install

            1. Download the installer below (.exe file)
            2. Run the installer (requires administrator privileges)
            3. The installer will automatically:
               - Download and install MongoDB if not already present (requires internet connection)
               - Configure MongoDB to start on system startup
               - Set up the application
               - Create desktop and start menu shortcuts
            4. Installation takes 5-10 minutes depending on internet speed

            **Note:** If the automatic MongoDB download fails during installation, you can manually download and install MongoDB from:
            [MongoDB 8.0.4 for Windows](https://fastdl.mongodb.org/windows/mongodb-windows-x86_64-8.0.4-signed.msi) or [Latest MongoDB Community Server](https://www.mongodb.com/try/download/community)

            ### Features

            - Offline-first room allocation and booking system
            - Customer management with ID verification
            - Multi-room booking support
            - Payment tracking (UPI, Cash, Credit/Debit cards)
            - Bill and declaration PDF generation
            - Automatic scheduled backups
            - Google Drive integration for backups
            - In-app update checking

            ### System Requirements

            - Windows 10/11 (64-bit)
            - 4GB RAM minimum
            - 500MB free disk space
            - Internet connection for updates and Google Drive sync

            ### Auto-Update

            The application includes built-in update checking. Click "Check Update" in the app to check for new versions, then "Update & Restart" to install updates automatically.

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.VERSION }}...HEAD
          draft: false
          prerelease: false

      - name: Upload Installer to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.installer.outputs.INSTALLER_PATH }}
          asset_name: ${{ steps.installer.outputs.INSTALLER_NAME }}
          asset_content_type: application/x-msdownload

      - name: Update latest release tag
        shell: pwsh
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -f latest
          git push -f origin latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
