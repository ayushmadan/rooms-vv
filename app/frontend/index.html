<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vira Villas Rooms Desk</title>
    <link rel="icon" type="image/png" href="/assets/logo.png" />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="bg"></div>
    <main class="app">
      <header class="card topbar">
        <div class="brand">
          <img src="/assets/logo.png" alt="Vira Villas Rooms" class="logo" />
          <div>
            <h1>Vira Villas Rooms</h1>
            <p>Local Reservation, Billing, Payments and Ledger</p>
          </div>
        </div>
        <div class="top-actions">
          <button id="seedRoomsBtn" class="btn btn-outline">Initialize Inventory</button>
          <button id="checkUpdateBtn" class="btn btn-outline">Check Update</button>
          <button id="runUpdateBtn" class="btn btn-outline">Update & Restart</button>
          <label>Role
            <select id="roleSelect">
              <option value="STAFF">Staff</option>
              <option value="ADMIN">Admin</option>
            </select>
          </label>
          <label>Admin PIN
            <input id="adminPin" type="password" placeholder="PIN" />
          </label>
          <span id="adminState" class="badge warn">Admin Mode Inactive</span>
          <span id="healthIndicator" class="health-indicator" title="System Health">
            <span class="health-dot"></span> System
          </span>
          <span id="versionInfo" class="badge ok">Version -</span>
        </div>
      </header>

      <nav class="card tabbar" id="mainTabs">
        <button class="tab-btn active" data-tab-target="booking">Booking</button>
        <button class="tab-btn" data-tab-target="operations">Operations</button>
        <button class="tab-btn" data-tab-target="billing">Billing</button>
        <button class="tab-btn" data-tab-target="admin">Admin</button>
        <button class="tab-btn" data-tab-target="backups">Backups</button>
      </nav>

      <section class="tab-panel active" data-tab-panel="booking">
        <section class="card panel">
          <h2>New Booking</h2>
          <p class="muted">Check-in: 12:00 PM IST | Check-out: 11:00 AM IST</p>

          <div class="row row-3">
            <label>Check-in Date <input type="date" id="fromDate" /></label>
            <label>Check-out Date <input type="date" id="toDate" /></label>
            <button id="searchBtn" class="btn">Search Availability</button>
          </div>

          <div class="chip-group" id="floorFilterGroup">
            <label><input type="radio" name="floorFilter" value="ALL" checked /> All</label>
            <label><input type="radio" name="floorFilter" value="1" /> 1st Floor</label>
            <label><input type="radio" name="floorFilter" value="2" /> 2nd Floor</label>
            <label><input type="radio" name="floorFilter" value="PARTY_HALL" /> Party Hall</label>
            <label><input type="radio" name="floorFilter" value="DINING_HALL" /> Dining Hall</label>
          </div>

          <div id="roomsGrid" class="rooms-grid"></div>

          <div class="subgrid">
            <section>
              <h3>Selected Tile Bookings (Range)</h3>
              <div id="roomBookingsList" class="booking-card-list"></div>
            </section>
            <section>
              <h3>Live Quote</h3>
              <div id="quoteBox" class="quote"></div>
            </section>
          </div>

          <form id="bookingForm" class="booking-form" enctype="multipart/form-data">
            <h3>Customer</h3>
            <div class="stack-inline">
              <button type="button" id="copyCustomerBtn" class="btn btn-outline">Copy Customer Details</button>
              <button type="button" id="pasteCustomerBtn" class="btn btn-outline">Paste Customer Details</button>
            </div>

            <!-- Customer Search by Phone -->
            <div class="row row-2" style="margin-bottom: 1rem;">
              <label>Search by Phone <input id="searchCustomerPhone" type="tel" placeholder="Enter phone number" /></label>
              <div style="display: flex; align-items: flex-end;">
                <button type="button" id="searchCustomerBtn" class="btn btn-outline">Search Customer</button>
              </div>
            </div>
            <p id="customerSearchStatus" class="status"></p>

            <div class="row row-2">
              <label>Full Name <input name="fullName" required /></label>
              <label>Phone <input name="phone" required /></label>
              <label>Email <input name="email" type="email" /></label>
              <label>Address <input name="address" /></label>
            </div>
            <label>Photo ID Upload <input name="photoId" type="file" accept="image/*" required /></label>

            <div class="sub-title">ID Type</div>
            <div class="chip-group" id="idTypeGroup">
              <label><input type="radio" name="idTypeRadio" value="AADHAAR" checked /> Aadhaar</label>
              <label><input type="radio" name="idTypeRadio" value="PASSPORT" /> Passport</label>
              <label><input type="radio" name="idTypeRadio" value="DRIVING_LICENSE" /> Driving License</label>
              <label><input type="radio" name="idTypeRadio" value="VOTER_ID" /> Voter ID</label>
              <label><input type="radio" name="idTypeRadio" value="OTHER" /> Other</label>
            </div>
            <label id="idTypeOtherWrap" class="hidden">Other ID Type <input id="idTypeOther" /></label>
            <label>ID Number <input name="idNumber" required /></label>

            <h3>Pricing</h3>
            <div class="row row-3">
              <label>Selected Units <input id="selectedUnitText" readonly placeholder="Select one or more tiles" /></label>
              <label>Rent / Night (Rs) <input id="nightlyRent" type="number" min="0" step="1" required /></label>
              <label>Payment Mode
                <select id="paymentMode">
                  <option value="UPI">UPI</option>
                  <option value="CASH">Cash</option>
                  <option value="CREDIT_CARD">Credit Card</option>
                  <option value="DEBIT_CARD">Debit Card</option>
                </select>
              </label>
            </div>
            <div class="row row-2">
              <label>Notes <input id="bookingNotes" /></label>
            </div>

            <h3>Advance Payment</h3>
            <div class="row row-2">
              <label>Advance Collected (Rs) <input id="advancePaid" type="number" min="0" step="1" value="0" /></label>
            </div>

            <h3>Meal Selection</h3>
            <div class="sub-title">Meal Planner by Date</div>
            <div id="mealPlanner" class="meal-planner"></div>

            <h3>Discounts (Optional)</h3>
            <div class="row row-2">
              <label>Room Discount Type
                <select id="roomDiscountType">
                  <option value="NONE">No Discount</option>
                  <option value="PERCENTAGE">Percentage (%)</option>
                  <option value="AMOUNT">Fixed Amount (Rs)</option>
                </select>
              </label>
              <label>Room Discount Value
                <input id="roomDiscountValue" type="number" min="0" step="0.01" value="0" placeholder="0" />
              </label>
            </div>
            <div class="row row-2">
              <label>Meal Discount Type
                <select id="mealDiscountType">
                  <option value="NONE">No Discount</option>
                  <option value="PERCENTAGE">Percentage (%)</option>
                  <option value="AMOUNT">Fixed Amount (Rs)</option>
                </select>
              </label>
              <label>Meal Discount Value
                <input id="mealDiscountValue" type="number" min="0" step="0.01" value="0" placeholder="0" />
              </label>
            </div>
            <p class="hint" style="font-size: 0.85rem; color: #666; margin-top: -8px;">Note: Discounts apply only to rooms and meals, not extra items.</p>

            <input type="hidden" id="roomIdField" />
            <button type="submit" class="btn">Create Booking</button>
          </form>
          <p id="bookingStatus" class="status"></p>
        </section>
      </section>

      <section class="tab-panel" data-tab-panel="operations">
        <div class="two-col">
          <section class="card panel">
            <h2>Booking Actions</h2>
            <div class="row row-2">
              <label>From Date <input id="opFromDate" type="date" /></label>
              <label>To Date <input id="opToDate" type="date" /></label>
            </div>
            <div id="opRoomsGrid" class="rooms-grid compact"></div>

            <input type="hidden" id="selectedRoomIdForView" />

            <h3>Bookings In Selected Range/Room</h3>
            <div id="opBookingList" class="booking-card-list"></div>

            <input type="hidden" id="manageBookingId" />

            <div id="selectedBookingPanel" class="selected-booking-panel hidden">
              <h3>Selected Booking</h3>
              <div class="booking-detail-card">
                <div class="detail-row">
                  <span class="detail-label">Booking ID:</span>
                  <strong id="selectedBookingRef">-</strong>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Customer:</span>
                  <strong id="selectedCustomerName">-</strong>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Current Unit:</span>
                  <strong id="selectedCurrentUnit">-</strong>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Check-in:</span>
                  <strong id="selectedCheckIn">-</strong>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Check-out:</span>
                  <strong id="selectedCheckOut">-</strong>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Status:</span>
                  <strong id="selectedStatus">-</strong>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Payment:</span>
                  <strong id="selectedPaymentInfo">-</strong>
                </div>
              </div>

              <h4 style="margin-top: 16px;">Quick Actions</h4>
              <div class="stack">
                <button id="checkInBtn" class="btn">Record Check-in</button>
                <button id="checkOutBtn" class="btn">Record Check-out</button>
                <button id="cleanedBtn" class="btn">Record Cleaned</button>
                <button id="cancelBookingBtn" class="btn btn-outline danger">Cancel Booking</button>
              </div>

              <h4 style="margin-top: 16px;">Reschedule / Move Booking</h4>
              <div class="row row-2">
                <label>Move To Unit
                  <select id="moveRoomId">
                    <option value="">Select Unit</option>
                  </select>
                </label>
                <label>Nightly Rate (Rs) <input id="moveRent" type="number" min="0" step="1" /></label>
                <label>New Check-in <input id="moveCheckIn" type="date" /></label>
                <label>New Check-out <input id="moveCheckOut" type="date" /></label>
              </div>
              <button id="moveBookingBtn" class="btn">Move Booking</button>
              <p id="manageStatus" class="status"></p>
          </section>

          <section class="card panel">
            <h2>Bookings (IST)</h2>
            <div class="table-wrap">
              <table id="bookingsTable">
                <thead>
                  <tr>
                    <th>Booking ID</th>
                    <th>Customer</th>
                    <th>Unit</th>
                    <th>Check-in</th>
                    <th>Check-out</th>
                    <th>Status</th>
                    <th>Payment</th>
                    <th>Due</th>
                    <th>Paid</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="pager">
              <button id="opsPrevBtn" class="btn btn-outline" type="button">Previous</button>
              <span id="opsPageInfo">Page 1</span>
              <button id="opsNextBtn" class="btn btn-outline" type="button">Next</button>
            </div>
          </section>
        </div>
      </section>

      <section class="tab-panel" data-tab-panel="billing">
        <div class="two-col">
          <!-- Left Panel: Room tiles for booking selection -->
          <section class="card panel">
            <h2>Select Booking</h2>
            <div class="row row-2">
              <label>From <input id="billingFromDate" type="date" /></label>
              <label>To <input id="billingToDate" type="date" /></label>
            </div>
            <div id="billingRoomsGrid" class="rooms-grid"></div>
          </section>

          <!-- Right Panel: Payments & Billing -->
          <section class="card panel">
            <!-- Selected Booking Info Card -->
            <div id="selectedPaymentInfo" class="card" style="background: #f3f4f6; padding: 1rem; margin-bottom: 1rem; display: none;">
              <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Selected Booking</h3>
              <div style="display: grid; gap: 0.5rem; font-size: 0.9rem;">
                <div><strong>Booking ID:</strong> <span id="selectedPaymentBookingId">-</span></div>
                <div><strong>Customer:</strong> <span id="selectedPaymentCustomer">-</span></div>
                <div><strong>Unit:</strong> <span id="selectedPaymentUnit">-</span></div>
                <div><strong>Total Due:</strong> <span id="selectedPaymentDue" style="color: #dc2626;">-</span></div>
                <div><strong>Total Paid:</strong> <span id="selectedPaymentPaid" style="color: #16a34a;">-</span></div>
                <div><strong>Outstanding:</strong> <span id="selectedPaymentOutstanding" style="color: #ea580c;">-</span></div>
              </div>
            </div>

            <!-- Payments Section (moved from Operations) -->
            <h2>Payments</h2>
            <div class="row row-2">
              <label>Amount (Rs) <input id="paymentAmount" type="number" min="0" step="1" value="0" /></label>
              <label>Mode
                <select id="paymentModeUpdate">
                  <option value="UPI">UPI</option>
                  <option value="CASH">Cash</option>
                  <option value="CREDIT_CARD">Credit Card</option>
                  <option value="DEBIT_CARD">Debit Card</option>
                </select>
              </label>
              <label>Type
                <select id="paymentType">
                  <option value="ADVANCE">Advance</option>
                  <option value="SETTLEMENT" selected>Settlement</option>
                  <option value="REFUND">Refund</option>
                </select>
              </label>
              <label>Note <input id="paymentNote" /></label>
            </div>
            <div class="stack">
              <button id="addPaymentBtn" class="btn">Record Payment</button>
              <button id="markBillPaidBtn" class="btn btn-outline">Mark Bill as Fully Paid</button>
            </div>
            <p id="paymentStatus" class="status"></p>

            <!-- Billing Section -->
            <h2 style="margin-top: 2rem;">Generate Bill</h2>

            <!-- Add Extra Items -->
            <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Add Extra Items</h3>
            <div class="sub-title">Item Category</div>
            <div class="chip-group">
              <label><input type="radio" name="extraLabelRadio" value="Food" checked /> Food</label>
              <label><input type="radio" name="extraLabelRadio" value="Laundry" /> Laundry</label>
              <label><input type="radio" name="extraLabelRadio" value="Service" /> Service</label>
              <label><input type="radio" name="extraLabelRadio" value="Other" /> Other</label>
            </div>
            <label id="extraOtherWrap" class="hidden">Other Label <input id="extraOtherLabel" /></label>
            <label>Amount (Rs) <input id="extraAmount" type="number" min="0" step="1" value="0" /></label>
            <button id="addExtraItemBtn" class="btn btn-outline">Add Item to List</button>

            <!-- Extra Items List -->
            <div id="extraItemsListWrap" style="margin-top: 1rem; display: none;">
              <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Extra Items Added:</h4>
              <div id="extraItemsList" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
            </div>

            <!-- Bill Generation -->
            <div class="stack" style="margin-top: 1.5rem;">
              <button id="generateBillBtn" class="btn">Generate Bill PDF</button>
              <button id="openBillBtn" class="btn btn-outline">Open/Print Bill</button>
              <button id="declarationBtn" class="btn btn-outline">Open/Print Declaration</button>
            </div>
            <p id="billStatus" class="status"></p>
          </section>
        </div>
      </section>

      <section class="tab-panel" data-tab-panel="admin">
        <div class="two-col">
          <section class="card panel" id="adminConfigPanel">
            <h2>Admin Pricing & GST</h2>
            <div class="row row-2">
              <label>Small Room Rate (Rs/night) <input id="defSmall" type="number" min="0" /></label>
              <label>Large Room Rate (Rs/night) <input id="defBig" type="number" min="0" /></label>
              <label>Party Hall Rate (Rs/night) <input id="defParty" type="number" min="0" /></label>
              <label>Dining Hall Rate (Rs/night) <input id="defDining" type="number" min="0" /></label>
              <label>Breakfast Rate (Rs) <input id="defBreakfast" type="number" min="0" /></label>
              <label>Lunch Rate (Rs) <input id="defLunch" type="number" min="0" /></label>
              <label>Dinner Rate (Rs) <input id="defDinner" type="number" min="0" /></label>
              <label>GST % (inclusive) <input id="defGst" type="number" min="0" step="0.01" /></label>
            </div>
            <button id="saveDefaultsBtn" class="btn">Save Pricing Configuration</button>

            <h3>Specific Date Overrides</h3>
            <div class="row row-2">
              <label>Unit ID <input id="configRoomId" placeholder="For room rate override" /></label>
              <label>Date <input id="configDate" type="date" /></label>
              <label>Unit Rent (Rs) <input id="configRent" type="number" min="0" placeholder="Optional" /></label>
            </div>
            <div class="sub-title">Meal Rate Overrides for Date</div>
            <div class="row row-2">
              <label>Breakfast (Rs) <input id="configBreakfast" type="number" min="0" placeholder="Optional" /></label>
              <label>Lunch (Rs) <input id="configLunch" type="number" min="0" placeholder="Optional" /></label>
              <label>Dinner (Rs) <input id="configDinner" type="number" min="0" placeholder="Optional" /></label>
            </div>
            <button id="saveRateBtn" class="btn">Save Date Overrides</button>
            <p id="configStatus" class="status"></p>
          </section>

          <section class="card panel" id="customerEditPanel">
            <h2>Customer Information Management</h2>
            <label>Customer ID <input id="editCustomerId" /></label>
            <label>Full Name <input id="editCustomerName" /></label>
            <label>Phone <input id="editCustomerPhone" /></label>
            <button id="saveCustomerBtn" class="btn">Update Customer</button>
            <p id="customerEditStatus" class="status"></p>

            <h2 class="top-gap">Admin Ledger</h2>
            <section id="ledgerPanel">
              <div class="row row-2">
                <label>From <input id="ledgerFrom" type="date" /></label>
                <label>To <input id="ledgerTo" type="date" /></label>
              </div>
              <button id="loadLedgerBtn" class="btn">Load Ledger Report</button>

              <!-- Summary Cards -->
              <div id="ledgerSummaryCards" class="row row-3" style="margin-top: 1rem; display: none;">
                <div class="card" style="padding: 0.75rem; text-align: center;">
                  <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Bookings/Bills</div>
                  <div id="summaryBookings" style="font-size: 1.25rem; font-weight: 600; color: #2563eb;">-</div>
                </div>
                <div class="card" style="padding: 0.75rem; text-align: center;">
                  <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Total Due</div>
                  <div id="summaryDue" style="font-size: 1.25rem; font-weight: 600; color: #dc2626;">-</div>
                </div>
                <div class="card" style="padding: 0.75rem; text-align: center;">
                  <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Total Paid</div>
                  <div id="summaryPaid" style="font-size: 1.25rem; font-weight: 600; color: #16a34a;">-</div>
                </div>
                <div class="card" style="padding: 0.75rem; text-align: center;">
                  <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Outstanding</div>
                  <div id="summaryOutstanding" style="font-size: 1.25rem; font-weight: 600; color: #ea580c;">-</div>
                </div>
              </div>

              <!-- Ledger Table -->
              <div id="ledgerTableContainer" style="margin-top: 1rem; overflow-x: auto; display: none;">
                <table id="ledgerTable" style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                  <thead>
                    <tr style="background: #f3f4f6; border-bottom: 2px solid #d1d5db;">
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Booking ID</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Customer</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Unit</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Check-in</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Check-out</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Status</th>
                      <th style="padding: 0.75rem; text-align: left; font-weight: 600;">Payment</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Amount Due</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Paid</th>
                      <th style="padding: 0.75rem; text-align: right; font-weight: 600;">Outstanding</th>
                    </tr>
                  </thead>
                  <tbody id="ledgerTableBody">
                    <!-- Rows will be populated by JavaScript -->
                  </tbody>
                </table>
              </div>

              <p id="ledgerStatus" class="status"></p>
            </section>
          </section>
        </div>
      </section>

      <section class="tab-panel" data-tab-panel="backups">
        <section class="card panel narrow">
          <h2>Backups</h2>
          <div class="row row-2">
            <label>From Date <input type="date" id="backupFrom" /></label>
            <label>To Date <input type="date" id="backupTo" /></label>
          </div>
          <button id="exportBackupBtn" class="btn">Create Backup CSV</button>
          <p id="backupStatus" class="status"></p>
          <div class="sub-title">Upload Selected CSV to Google Drive</div>
          <div id="backupFiles" class="list-box"></div>
          <button id="uploadSelectedBtn" class="btn btn-outline">Upload Selected Files</button>
          <p id="uploadStatus" class="status"></p>
        </section>
      </section>
    </main>

    <div id="feedbackModal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-card">
        <h3 id="feedbackTitle">Status</h3>
        <p id="feedbackMessage"></p>
        <button id="feedbackCloseBtn" class="btn" type="button">Close</button>
      </div>
    </div>

    <div id="pinModal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-card">
        <h3 id="pinModalTitle">Admin Authentication Required</h3>
        <p id="pinModalMessage">Enter Admin PIN to continue this action:</p>
        <label style="margin-top: 12px;">
          Admin PIN
          <input id="pinModalInput" type="password" placeholder="Enter PIN" />
        </label>
        <p id="pinModalError" class="status" style="color: #a4372f; display: none;"></p>
        <div class="stack-inline" style="margin-top: 12px;">
          <button id="pinModalCancel" class="btn btn-outline" type="button">Cancel</button>
          <button id="pinModalConfirm" class="btn" type="button">Confirm</button>
        </div>
      </div>
    </div>

    <div id="checkinModal" class="modal hidden" role="dialog" aria-modal="true">
      <div class="modal-card" style="width: min(540px, 92vw);">
        <h3>Confirm Check-in</h3>
        <p class="muted" style="margin-bottom: 12px;">Review and edit customer information before check-in:</p>

        <div style="background: #f8fbfd; border: 1px solid #d5e3ec; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
          <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 0.85rem;">
            <span style="color: var(--muted);">Unit:</span>
            <strong id="checkinUnit">-</strong>
            <span style="color: var(--muted);">Check-in:</span>
            <strong id="checkinDateTime">-</strong>
            <span style="color: var(--muted);">Booking ID:</span>
            <strong id="checkinBookingId">-</strong>
          </div>
        </div>

        <label>Full Name <input id="checkinName" /></label>
        <label>Phone <input id="checkinPhone" /></label>
        <label>ID Type
          <select id="checkinIdType">
            <option value="AADHAAR">Aadhaar</option>
            <option value="PASSPORT">Passport</option>
            <option value="DRIVING_LICENSE">Driving License</option>
            <option value="VOTER_ID">Voter ID</option>
            <option value="OTHER">Other</option>
          </select>
        </label>
        <label id="checkinIdTypeOtherWrap" class="hidden">Other ID Type <input id="checkinIdTypeOther" /></label>
        <label>ID Number <input id="checkinIdNumber" /></label>
        <label>Address <input id="checkinAddress" /></label>

        <p id="checkinModalError" class="status" style="color: #a4372f; display: none; margin-top: 8px;"></p>

        <div class="stack-inline" style="margin-top: 12px;">
          <button id="checkinModalCancel" class="btn btn-outline" type="button">Cancel</button>
          <button id="checkinModalConfirm" class="btn" type="button">Confirm Check-in</button>
        </div>
      </div>
    </div>

    <script src="/app.js"></script>
  </body>
</html>
